<html>

  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
      #livedata {
          height: 100px;
      }
    </style>
  <script>
var succ;
var data = {};
var dist_array = [];
var interval;
function init() {
  var SERVER = "https://api.dreampotential.org/";
  // var SERVER = "http://localhost:8000/";
  var CURRENT_POSITION = null;

  if(!localStorage.getItem("token")) {
    alert("Need to login")
    window.location = '/sms_login.html'
  }
  var time_t;
  $("body").delegate("#start_session", "click", function(e) {
      $("#start_session").hide()
      $("#stop_session").show()
      $('#distance').html('');

      var today = new Date();

      // XXX SEND CURRENT_POSITION to server on interval loop
      $(document).ready(function () {
            $.ajax({
                url: SERVER + "sfapp2/api/member_session_start",
                async: true,
                crossDomain: true,
                type: "POST",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                processData: false,
                headers: {
                    Authorization: localStorage.getItem('token'),
                  },
                success: function (response) {
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 36 ~ response", response)
                    succ = response.status;
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 40 ~ succ", succ)
                    const out = document.getElementById("livedata")
                    let c = 1
                    interval = setInterval(function() {

                      var today_current = new Date();
                      // var time_current = today_current.getHours() + ":" + today_current.getMinutes() + ":" + today_current.getSeconds();
                      var t_hours = today_current.getHours() - today.getHours()
                      var t_minutes = today_current.getMinutes() - today.getMinutes()
                      var t_seconds = today_current.getSeconds() - today.getSeconds()
                      var total_time_current = t_hours + ":" + t_minutes + ":" + t_seconds;
                      console.log("ðŸš€ ~ file: gps_session.html ~ line 65 ~ interval=setInterval ~ total_time_current", total_time_current)

                      
                      dist_array.push(data['latitude'])
                      dist_array.push(data['longitude'])
                      var lat1 = dist_array[0]
                      var lon1 = dist_array[1]
                      var lat2 = data['latitude']
                      var lon2 =data['longitude']
                      var dista = getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2)
                      console.log("ðŸš€ ~ file: gps_session.html ~ line 60 ~ interval=setInterval ~ dista", dista)
                      
                      var avg_time = (t_hours*60*60) + (t_minutes*60) + t_seconds
                      avg_speed = (dista *1000) / avg_time

                      const isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + 1
                      const newElement = document.createElement("div")
                      newElement.textContent = format(c++, "Total Distance : ", dista,  'Speed :', avg_speed,"Total Time :",total_time_current)
                      out.appendChild(newElement)
                      if (isScrolledToBottom) {
                        out.scrollTop = out.scrollHeight - out.clientHeight
                      }
                      // console.log("ðŸš€ ~ file: gps_session.html ~ line 62 ~ interval=setInterval ~ startTime", time)
                      //your jQuery ajax code
                    //   $(document).ready(function () {
                    //         $.ajax({
                    //             url: SERVER + "sfapp2/api/member_session_livedata",
                    //             async: true,
                    //             crossDomain: true,
                    //             type: "POST",
                    //             data: JSON.stringify(data),
                    //             dataType: "json",
                    //             contentType: "application/json; charset=utf-8",
                    //             processData: false,
                    //             headers: {
                    //                 Authorization: localStorage.getItem('token'),
                    //               },
                    //             success: function (response) {
                    //                 console.log("ðŸš€ ~ file: gps_session.html ~ line 57 ~ response", response)
                    //                 time_t = response.total_time
                    //                 const isScrolledToBottom = out.scrollHeight - out.clientHeight <= out.scrollTop + 1
                    //                 const newElement = document.createElement("div")
                    //                 newElement.textContent = format(c++, "Total Distance : ", response.distance,  'Speed :', response.avg_speed,"Total Time :",response.total_time)
                    //                 // newElement.textContent = "Total Distance : "+ response.distance +" km  Speed : "+ response.avg_speed + " m/s Total Time : "+ response.total_time +" second";
                    //                 out.appendChild(newElement)
                    //                 if (isScrolledToBottom) {
                    //                     out.scrollTop = out.scrollHeight - out.clientHeight
                    //                   }

                    //                 // var elTime = document.getElementById("livedata");
                    //                 // elTime.textContent = "Total Distance : "+ response.distance +" km  Speed : "+ response.avg_speed + " m/s Total Time : "+ response.total_time +" second";
                    //             },
                    //             error: function (err) {
                    //               console.log("ðŸš€ ~ file: gps_session.html ~ line 60 ~ err", err)
                    //             },
                    //         });
                    // });
                    function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
                        var R = 6371; // Radius of the earth in km
                        var dLat = deg2rad(lat2-lat1);  // deg2rad below
                        var dLon = deg2rad(lon2-lon1); 
                        var a = 
                          Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                          Math.sin(dLon/2) * Math.sin(dLon/2)
                          ; 
                        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
                        var d = R * c; // Distance in km
                        return d;
                  }

                  function deg2rad(deg) {
                    return deg * (Math.PI/180)
                  }

                      }, 1000 * 3); 
                      function format () {
                          return Array.prototype.slice.call(arguments).join(' ')
                        }
                      // where X is your every X minutes
                    // Whatever you want to do after the form is successfully submitted
                },
                error: function (err) {
                  console.log("ðŸš€ ~ file: gps_session.html ~ line 42 ~ err", err)
                  succ = err.status;
                },
            });
    });

  });

  $("body").delegate("#stop_session", "click", function(e) {
      $("#start_session").show()
      $("#stop_session").hide()
      if (succ == "okay"){
        console.log("ðŸš€ ~ file: gps_session.html ~ line 55 ~ $ ~ succ", succ)
        clearInterval(interval);
        $(document).ready(function () {
              $.ajax({
                  url: SERVER + "sfapp2/api/member_session_stop",
                  async: true,
                  crossDomain: true,
                  type: "POST",
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: "application/json; charset=utf-8",
                  processData: false,
                  headers: {
                      Authorization: localStorage.getItem('token'),
                    },
                  success: function (response) {
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 71 ~ response", response);
                    if (response.status == 'okay'){
  
                      $(document).ready(function () {
                            $.ajax({
                                url: SERVER + "sfapp2/api/member_session_distance",
                                async: true,
                                crossDomain: true,
                                type: "GET",
                                contentType: false,
                                processData: false,
                                headers: {  
                                    Authorization: localStorage.getItem('token'),
                                  },
                                success: function (response) {
                                  console.log("ðŸš€ ~ file: gps_session.html ~ line 71 ~ response", response);
                                    // Whatever you want to do after the form is successfully submitted
                                    if(response.status == "error"){
                                    console.log("ðŸš€ ~ file: gps_session.html ~ line 90 ~ response.status", response.status)

                                    }else{
                                      // $("#livedata").hide()
                                      
                                      $('#distance').append("<h2>Total Distance : "+ response.distance +" km</h2><h2>Averege Speed : "+ response.avg_speed + " m/s</h2><h2>Total Time : "+ response.total_time +" second</h2>")
                                      
                                      succ = ""
                                    }
                                },
                                error: function (err) {
                                  console.log("ðŸš€ ~ file: gps_session.html ~ line 75 ~ err", err);
                                },
                            });
                    });
                    }
                      // Whatever you want to do after the form is successfully submitted
                  },
                  error: function (err) {
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 75 ~ err", err);
                  },
              });
      });
      }

  });


  var geo_options = {
    enableHighAccuracy: true,
    maximumAge: 30000,
    timeout: 2700,
  };

  navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);

  function geo_error(err) {
    if (
      err.code == 1 ||
      err.code == err.PERMISSION_DENIED ||
      err.code == err.UNKNOWN_ERROR
    ) {
        alert("GPS error")
      }
      console.log("errror no gps");
      console.warn("ERROR(" + err.code + "): " + err.message);

    }
  }

  function geo_success(position) {
    CURRENT_POSITION = position;
    console.log(position.coords.latitude + " " + position.coords.longitude);
    data['latitude'] = position.coords.latitude;
    data['longitude'] = position.coords.longitude;
  }


  let acl = new Accelerometer({frequency: 60});
  acl.addEventListener('reading', () => {
    console.log("Acceleration along the X-axis " + acl.x);
    console.log("Acceleration along the Y-axis " + acl.y);
    console.log("Acceleration along the Z-axis " + acl.z);
  });
  console.log("ðŸš€ ~ file: gps_session.html ~ line 174 ~ acl", acl)
  acl.start();
  // let magSensor = new Magnetometer({frequency: 60});

  window.addEventListener("DOMContentLoaded", init, false);
  
  function handleOrientation(event) {
    var absolute = event.absolute;
    console.log("ðŸš€ ~ file: gps_session.html ~ line 213 ~ handleOrientation ~ absolute", absolute)
    var alpha    = event.alpha;
    console.log("ðŸš€ ~ file: gps_session.html ~ line 215 ~ handleOrientation ~ alpha", alpha)
    var beta     = event.beta;
    console.log("ðŸš€ ~ file: gps_session.html ~ line 217 ~ handleOrientation ~ beta", beta)
    var gamma    = event.gamma;
    console.log("ðŸš€ ~ file: gps_session.html ~ line 219 ~ handleOrientation ~ gamma", gamma)
    // Do stuff with the new orientation data
  }
  window.addEventListener("deviceorientation", handleOrientation, true);
// handleOrientation()
  </script>

  </head>


  <body>
    <div id="livedata" style="overflow:auto"></div>
    <button id='start_session'>Start Session</button>
    <button id='stop_session' style='display:none;'>Stop Session</button>
    <div id='distance' >
    </div>
  </body>
<html>


