<html>

  <head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

  <script>
var succ;
var data = {};
function init() {
  var SERVER = "https://api.dreampotential.org/";
  // var SERVER = "http://localhost:8000/";
  var CURRENT_POSITION = null;

  if(!localStorage.getItem("token")) {
    alert("Need to login")
    window.location = '/sms_login.html'
  }

  $("body").delegate("#start_session", "click", function(e) {
      $("#start_session").hide()
      $("#stop_session").show()
      $('#distance').html('');
      // XXX SEND CURRENT_POSITION to server on interval loop
      $(document).ready(function () {
            $.ajax({
                url: SERVER + "sfapp2/api/member_session_start",
                async: true,
                crossDomain: true,
                type: "POST",
                data: JSON.stringify(data),
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                processData: false,
                headers: {
                    Authorization: localStorage.getItem('token'),
                  },
                success: function (response) {
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 36 ~ response", response)
                    succ = response.status;
                    // Whatever you want to do after the form is successfully submitted
                },
                error: function (err) {
                  console.log("ðŸš€ ~ file: gps_session.html ~ line 42 ~ err", err)
                },
            });
    });

  });

  $("body").delegate("#stop_session", "click", function(e) {
      $("#start_session").show()
      $("#stop_session").hide()
      if (succ !== 'error' ){

        $(document).ready(function () {
              $.ajax({
                  url: SERVER + "sfapp2/api/member_session_stop",
                  async: true,
                  crossDomain: true,
                  type: "POST",
                  data: JSON.stringify(data),
                  dataType: "json",
                  contentType: "application/json; charset=utf-8",
                  processData: false,
                  headers: {
                      Authorization: localStorage.getItem('token'),
                    },
                  success: function (response) {
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 71 ~ response", response);
                    if (response.response !== 'error'){
  
                      $(document).ready(function () {
                            $.ajax({
                                url: SERVER + "sfapp2/api/member_session_distance",
                                async: true,
                                crossDomain: true,
                                type: "GET",
                                contentType: false,
                                processData: false,
                                headers: {
                                    Authorization: localStorage.getItem('token'),
                                  },
                                success: function (response) {
                                  console.log("ðŸš€ ~ file: gps_session.html ~ line 71 ~ response", response);
                                    // Whatever you want to do after the form is successfully submitted
                                    $('#distance').append("<h2>Total Distance : "+ response.distance +" km</h2><h2>Averege Speed : "+ response.avg_speed + " m/s</h2><h2>Total Time : "+ response.total_time +" second</h2>")
                                    succ = ""
                                },
                                error: function (err) {
                                  console.log("ðŸš€ ~ file: gps_session.html ~ line 75 ~ err", err);
                                },
                            });
                    });
                    }
                      // Whatever you want to do after the form is successfully submitted
                  },
                  error: function (err) {
                    console.log("ðŸš€ ~ file: gps_session.html ~ line 75 ~ err", err);
                  },
              });
      });
      }

  });


  var geo_options = {
    enableHighAccuracy: true,
    maximumAge: 30000,
    timeout: 2700,
  };

  navigator.geolocation.watchPosition(geo_success, geo_error, geo_options);

  function geo_error(err) {
    if (
      err.code == 1 ||
      err.code == err.PERMISSION_DENIED ||
      err.code == err.UNKNOWN_ERROR
    ) {
        alert("GPS error")
      }
      console.log("errror no gps");
      console.warn("ERROR(" + err.code + "): " + err.message);

    }
  }

  function geo_success(position) {
    CURRENT_POSITION = position;
    console.log(position.coords.latitude + " " + position.coords.longitude);
    data['latitude'] = position.coords.latitude;
    data['longitude'] = position.coords.longitude;
  }

  window.addEventListener("DOMContentLoaded", init, false);

  </script>

  </head>


  <body>
    <button id='start_session'>Start Session</button>
    <button id='stop_session' style='display:none;'>Stop Session</button>
    <div id='distance'>
    </div>
  </body>
<html>


